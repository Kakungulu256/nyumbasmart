import { Permission, Role } from 'node-appwrite'

const authenticatedCreate = [Permission.create(Role.users())]

export function buildSchema(ids) {
  return [
    {
      id: ids.collections.users,
      name: 'Users',
      permissions: authenticatedCreate,
      documentSecurity: true,
      attributes: [
        { key: 'userId', type: 'string', size: 36, required: true },
        { key: 'username', type: 'string', size: 30, required: false },
        { key: 'role', type: 'enum', required: true, elements: ['landlord', 'tenant', 'admin'] },
        { key: 'firstName', type: 'string', size: 80, required: true },
        { key: 'lastName', type: 'string', size: 80, required: true },
        { key: 'phone', type: 'string', size: 24, required: true },
        { key: 'avatarFileId', type: 'string', size: 64, required: false },
        { key: 'verifiedKYC', type: 'boolean', required: false, xdefault: false },
        { key: 'country', type: 'string', size: 2, required: true },
        { key: 'city', type: 'string', size: 80, required: false },
        { key: 'bio', type: 'string', size: 500, required: false },
        { key: 'businessName', type: 'string', size: 120, required: false },
        { key: 'propertiesManaged', type: 'integer', required: false, min: 0, xdefault: 0 },
        { key: 'notificationPreferences', type: 'string', size: 2000, required: false },
        { key: 'createdAt', type: 'datetime', required: false },
      ],
      indexes: [
        { key: 'users_userId_uq', type: 'unique', attributes: ['userId'] },
        { key: 'users_username_idx', type: 'key', attributes: ['username'] },
        { key: 'users_phone_uq', type: 'unique', attributes: ['phone'] },
        { key: 'users_role_idx', type: 'key', attributes: ['role'] },
        {
          key: 'users_country_city_idx',
          type: 'key',
          attributes: ['country', 'city'],
          orders: ['asc', 'asc'],
        },
      ],
    },
    {
      id: ids.collections.listings,
      name: 'Listings',
      permissions: authenticatedCreate,
      documentSecurity: true,
      attributes: [
        { key: 'landlordId', type: 'string', size: 36, required: true },
        { key: 'title', type: 'string', size: 140, required: true },
        { key: 'description', type: 'string', size: 2000, required: true },
        {
          key: 'listingIntent',
          type: 'enum',
          required: false,
          elements: ['rent', 'sale'],
          xdefault: 'rent',
        },
        {
          key: 'propertyType',
          type: 'enum',
          required: true,
          elements: ['apartment', 'house', 'duplex', 'land', 'room', 'studio', 'commercial'],
        },
        { key: 'rentAmount', type: 'integer', required: true, min: 0 },
        { key: 'currency', type: 'string', size: 3, required: true },
        {
          key: 'paymentFrequency',
          type: 'enum',
          required: true,
          elements: ['monthly', 'quarterly', 'annually'],
        },
        { key: 'bedrooms', type: 'integer', required: true, min: 0, max: 20 },
        { key: 'bathrooms', type: 'integer', required: true, min: 0, max: 20 },
        { key: 'amenities', type: 'string', size: 50, required: false, array: true },
        { key: 'imageFileIds', type: 'string', size: 64, required: false, array: true },
        { key: 'latitude', type: 'float', required: true, min: -90, max: 90 },
        { key: 'longitude', type: 'float', required: true, min: -180, max: 180 },
        { key: 'address', type: 'string', size: 240, required: true },
        { key: 'neighborhood', type: 'string', size: 120, required: false },
        { key: 'city', type: 'string', size: 80, required: true },
        { key: 'country', type: 'string', size: 2, required: true },
        {
          key: 'region',
          type: 'enum',
          required: false,
          elements: ['central', 'eastern', 'northern', 'western'],
        },
        { key: 'district', type: 'string', size: 80, required: false },
        {
          key: 'landTenureType',
          type: 'enum',
          required: false,
          elements: ['mailo_private', 'mailo_official', 'freehold', 'leasehold', 'customary'],
        },
        {
          key: 'status',
          type: 'enum',
          required: true,
          elements: ['available', 'occupied', 'draft', 'suspended'],
        },
        { key: 'availableFrom', type: 'datetime', required: false },
        { key: 'viewCount', type: 'integer', required: false, min: 0, xdefault: 0 },
        { key: 'createdAt', type: 'datetime', required: false },
        { key: 'updatedAt', type: 'datetime', required: false },
      ],
      relationships: [
        {
          key: 'landlord',
          type: 'relationship',
          relatedCollectionId: ids.collections.users,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
      ],
      indexes: [
        { key: 'list_landlord_idx', type: 'key', attributes: ['landlordId'] },
        { key: 'list_status_idx', type: 'key', attributes: ['status'] },
        {
          key: 'list_city_status_idx',
          type: 'key',
          attributes: ['city', 'status'],
          orders: ['asc', 'asc'],
        },
        {
          key: 'list_country_city_status',
          type: 'key',
          attributes: ['country', 'city', 'status'],
          orders: ['asc', 'asc', 'asc'],
        },
        { key: 'list_rent_idx', type: 'key', attributes: ['rentAmount'] },
        { key: 'list_type_idx', type: 'key', attributes: ['propertyType'] },
        {
          key: 'list_intent_status_idx',
          type: 'key',
          attributes: ['listingIntent', 'status'],
          orders: ['asc', 'asc'],
        },
        { key: 'list_region_idx', type: 'key', attributes: ['region'] },
        {
          key: 'list_region_district_idx',
          type: 'key',
          attributes: ['region', 'district'],
          orders: ['asc', 'asc'],
        },
        { key: 'list_land_tenure_idx', type: 'key', attributes: ['landTenureType'] },
        { key: 'list_available_idx', type: 'key', attributes: ['availableFrom'] },
        { key: 'list_created_idx', type: 'key', attributes: ['createdAt'] },
        {
          key: 'list_search_ft',
          type: 'fulltext',
          attributes: ['title', 'description', 'neighborhood', 'address', 'city'],
        },
      ],
    },
    {
      id: ids.collections.applications,
      name: 'Applications',
      permissions: authenticatedCreate,
      documentSecurity: true,
      attributes: [
        { key: 'listingId', type: 'string', size: 36, required: true },
        { key: 'tenantId', type: 'string', size: 36, required: true },
        { key: 'landlordId', type: 'string', size: 36, required: true },
        {
          key: 'status',
          type: 'enum',
          required: true,
          elements: ['pending', 'accepted', 'rejected', 'withdrawn'],
        },
        { key: 'moveInDate', type: 'datetime', required: false },
        { key: 'coverNote', type: 'string', size: 1200, required: false },
        { key: 'tenantDocFileIds', type: 'string', size: 64, required: false, array: true },
        { key: 'createdAt', type: 'datetime', required: false },
      ],
      relationships: [
        {
          key: 'listing',
          type: 'relationship',
          relatedCollectionId: ids.collections.listings,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
        {
          key: 'tenant',
          type: 'relationship',
          relatedCollectionId: ids.collections.users,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
        {
          key: 'landlord',
          type: 'relationship',
          relatedCollectionId: ids.collections.users,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
      ],
      indexes: [
        {
          key: 'app_listing_status_idx',
          type: 'key',
          attributes: ['listingId', 'status'],
          orders: ['asc', 'asc'],
        },
        {
          key: 'app_tenant_status_idx',
          type: 'key',
          attributes: ['tenantId', 'status'],
          orders: ['asc', 'asc'],
        },
        {
          key: 'app_landlord_status_idx',
          type: 'key',
          attributes: ['landlordId', 'status'],
          orders: ['asc', 'asc'],
        },
        { key: 'app_created_idx', type: 'key', attributes: ['createdAt'] },
      ],
    },
    {
      id: ids.collections.leases,
      name: 'Leases',
      permissions: authenticatedCreate,
      documentSecurity: true,
      attributes: [
        { key: 'listingId', type: 'string', size: 36, required: true },
        { key: 'tenantId', type: 'string', size: 36, required: true },
        { key: 'landlordId', type: 'string', size: 36, required: true },
        { key: 'startDate', type: 'datetime', required: true },
        { key: 'endDate', type: 'datetime', required: true },
        { key: 'monthlyRent', type: 'integer', required: true, min: 0 },
        { key: 'depositAmount', type: 'integer', required: false, min: 0 },
        {
          key: 'status',
          type: 'enum',
          required: true,
          elements: ['active', 'expired', 'terminated'],
        },
        { key: 'leaseDocFileId', type: 'string', size: 64, required: false },
        { key: 'tenantSigned', type: 'boolean', required: false, xdefault: false },
        { key: 'landlordSigned', type: 'boolean', required: false, xdefault: false },
        { key: 'terminationReason', type: 'string', size: 500, required: false },
        { key: 'createdAt', type: 'datetime', required: false },
      ],
      relationships: [
        {
          key: 'listing',
          type: 'relationship',
          relatedCollectionId: ids.collections.listings,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
        {
          key: 'tenant',
          type: 'relationship',
          relatedCollectionId: ids.collections.users,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
        {
          key: 'landlord',
          type: 'relationship',
          relatedCollectionId: ids.collections.users,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
      ],
      indexes: [
        {
          key: 'lease_listing_status',
          type: 'key',
          attributes: ['listingId', 'status'],
          orders: ['asc', 'asc'],
        },
        {
          key: 'lease_tenant_status',
          type: 'key',
          attributes: ['tenantId', 'status'],
          orders: ['asc', 'asc'],
        },
        {
          key: 'lease_landlord_status',
          type: 'key',
          attributes: ['landlordId', 'status'],
          orders: ['asc', 'asc'],
        },
        {
          key: 'lease_end_status',
          type: 'key',
          attributes: ['endDate', 'status'],
          orders: ['asc', 'asc'],
        },
      ],
    },
    {
      id: ids.collections.payments,
      name: 'Payments',
      permissions: authenticatedCreate,
      documentSecurity: true,
      attributes: [
        { key: 'leaseId', type: 'string', size: 36, required: true },
        { key: 'tenantId', type: 'string', size: 36, required: true },
        { key: 'landlordId', type: 'string', size: 36, required: true },
        { key: 'amount', type: 'integer', required: true, min: 0 },
        { key: 'currency', type: 'string', size: 3, required: true },
        {
          key: 'paymentMethod',
          type: 'enum',
          required: true,
          elements: ['mtn_momo', 'mpesa', 'airtel', 'card', 'cash'],
        },
        { key: 'transactionRef', type: 'string', size: 120, required: false },
        {
          key: 'status',
          type: 'enum',
          required: true,
          elements: ['pending', 'success', 'failed'],
        },
        { key: 'periodMonth', type: 'string', size: 7, required: true },
        { key: 'paidAt', type: 'datetime', required: false },
        { key: 'receiptFileId', type: 'string', size: 64, required: false },
        { key: 'createdAt', type: 'datetime', required: false },
      ],
      relationships: [
        {
          key: 'lease',
          type: 'relationship',
          relatedCollectionId: ids.collections.leases,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
        {
          key: 'tenant',
          type: 'relationship',
          relatedCollectionId: ids.collections.users,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
        {
          key: 'landlord',
          type: 'relationship',
          relatedCollectionId: ids.collections.users,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
      ],
      indexes: [
        {
          key: 'pay_lease_status',
          type: 'key',
          attributes: ['leaseId', 'status'],
          orders: ['asc', 'asc'],
        },
        {
          key: 'pay_tenant_status',
          type: 'key',
          attributes: ['tenantId', 'status'],
          orders: ['asc', 'asc'],
        },
        {
          key: 'pay_landlord_status',
          type: 'key',
          attributes: ['landlordId', 'status'],
          orders: ['asc', 'asc'],
        },
        { key: 'pay_period_idx', type: 'key', attributes: ['periodMonth'] },
        {
          key: 'pay_lease_period_uq',
          type: 'unique',
          attributes: ['leaseId', 'periodMonth'],
          orders: ['asc', 'asc'],
        },
      ],
    },
    {
      id: ids.collections.maintenanceTickets,
      name: 'Maintenance Tickets',
      permissions: authenticatedCreate,
      documentSecurity: true,
      attributes: [
        { key: 'leaseId', type: 'string', size: 36, required: true },
        { key: 'tenantId', type: 'string', size: 36, required: true },
        { key: 'landlordId', type: 'string', size: 36, required: true },
        { key: 'title', type: 'string', size: 140, required: true },
        { key: 'description', type: 'string', size: 2000, required: true },
        {
          key: 'category',
          type: 'enum',
          required: true,
          elements: ['plumbing', 'electrical', 'structural', 'pest', 'appliance', 'other'],
        },
        {
          key: 'priority',
          type: 'enum',
          required: true,
          elements: ['low', 'medium', 'high', 'emergency'],
        },
        {
          key: 'status',
          type: 'enum',
          required: true,
          elements: ['open', 'in_progress', 'resolved', 'closed'],
        },
        { key: 'imageFileIds', type: 'string', size: 64, required: false, array: true },
        { key: 'landlordNotes', type: 'string', size: 1500, required: false },
        { key: 'resolvedAt', type: 'datetime', required: false },
        { key: 'createdAt', type: 'datetime', required: false },
      ],
      relationships: [
        {
          key: 'lease',
          type: 'relationship',
          relatedCollectionId: ids.collections.leases,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
        {
          key: 'tenant',
          type: 'relationship',
          relatedCollectionId: ids.collections.users,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
        {
          key: 'landlord',
          type: 'relationship',
          relatedCollectionId: ids.collections.users,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
      ],
      indexes: [
        {
          key: 'ticket_landlord_status',
          type: 'key',
          attributes: ['landlordId', 'status'],
          orders: ['asc', 'asc'],
        },
        {
          key: 'ticket_tenant_status',
          type: 'key',
          attributes: ['tenantId', 'status'],
          orders: ['asc', 'asc'],
        },
        {
          key: 'ticket_lease_status',
          type: 'key',
          attributes: ['leaseId', 'status'],
          orders: ['asc', 'asc'],
        },
        {
          key: 'ticket_priority_status',
          type: 'key',
          attributes: ['priority', 'status'],
          orders: ['asc', 'asc'],
        },
        { key: 'ticket_created_idx', type: 'key', attributes: ['createdAt'] },
      ],
    },
    {
      id: ids.collections.messages,
      name: 'Messages',
      permissions: authenticatedCreate,
      documentSecurity: true,
      attributes: [
        { key: 'conversationId', type: 'string', size: 120, required: true },
        { key: 'listingId', type: 'string', size: 36, required: true },
        { key: 'senderId', type: 'string', size: 36, required: true },
        { key: 'receiverId', type: 'string', size: 36, required: true },
        { key: 'body', type: 'string', size: 1000, required: true },
        { key: 'read', type: 'boolean', required: false, xdefault: false },
        { key: 'createdAt', type: 'datetime', required: false },
      ],
      relationships: [
        {
          key: 'listing',
          type: 'relationship',
          relatedCollectionId: ids.collections.listings,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
        {
          key: 'sender',
          type: 'relationship',
          relatedCollectionId: ids.collections.users,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
        {
          key: 'receiver',
          type: 'relationship',
          relatedCollectionId: ids.collections.users,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
      ],
      indexes: [
        {
          key: 'msg_conversation_created',
          type: 'key',
          attributes: ['conversationId', 'createdAt'],
          orders: ['asc', 'desc'],
        },
        {
          key: 'msg_receiver_read',
          type: 'key',
          attributes: ['receiverId', 'read'],
          orders: ['asc', 'asc'],
        },
        {
          key: 'msg_sender_created',
          type: 'key',
          attributes: ['senderId', 'createdAt'],
          orders: ['asc', 'desc'],
        },
      ],
    },
    {
      id: ids.collections.notifications,
      name: 'Notifications',
      permissions: authenticatedCreate,
      documentSecurity: true,
      attributes: [
        { key: 'userId', type: 'string', size: 36, required: true },
        {
          key: 'type',
          type: 'enum',
          required: true,
          elements: [
            'application_new',
            'application_accepted',
            'application_rejected',
            'lease_signature_needed',
            'lease_signed',
            'lease_expiry',
            'maintenance_new',
            'maintenance_updated',
            'message_new',
          ],
        },
        { key: 'title', type: 'string', size: 140, required: true },
        { key: 'body', type: 'string', size: 1000, required: true },
        { key: 'channels', type: 'string', size: 20, required: false, array: true },
        {
          key: 'status',
          type: 'enum',
          required: true,
          elements: ['unread', 'read', 'archived'],
        },
        { key: 'entityType', type: 'string', size: 40, required: false },
        { key: 'entityId', type: 'string', size: 36, required: false },
        { key: 'sentAt', type: 'datetime', required: false },
        { key: 'createdAt', type: 'datetime', required: false },
      ],
      relationships: [
        {
          key: 'user',
          type: 'relationship',
          relatedCollectionId: ids.collections.users,
          relationType: 'manyToOne',
          onDelete: 'restrict',
        },
      ],
      indexes: [
        {
          key: 'notif_user_status_created',
          type: 'key',
          attributes: ['userId', 'status', 'createdAt'],
          orders: ['asc', 'asc', 'desc'],
        },
        {
          key: 'notif_type_created',
          type: 'key',
          attributes: ['type', 'createdAt'],
          orders: ['asc', 'desc'],
        },
      ],
    },
  ]
}

export function buildBuckets(ids) {
  return [
    {
      id: ids.buckets.listingImages,
      name: 'Listing Images',
      permissions: [
        Permission.read(Role.any()),
        Permission.create(Role.users()),
        Permission.update(Role.users()),
        Permission.delete(Role.users()),
      ],
      fileSecurity: false,
      maximumFileSize: 5 * 1024 * 1024,
      allowedFileExtensions: ['jpg', 'jpeg', 'png', 'webp'],
      compression: 'none',
      encryption: false,
      antivirus: true,
      transformations: true,
      enabled: true,
    },
    {
      id: ids.buckets.leaseDocuments,
      name: 'Lease Documents',
      permissions: [
        Permission.read(Role.users()),
        Permission.create(Role.users()),
        Permission.update(Role.users()),
        Permission.delete(Role.users()),
      ],
      fileSecurity: true,
      maximumFileSize: 10 * 1024 * 1024,
      allowedFileExtensions: ['pdf'],
      compression: 'none',
      encryption: true,
      antivirus: true,
      transformations: false,
      enabled: true,
    },
    {
      id: ids.buckets.tenantDocuments,
      name: 'Tenant Documents',
      permissions: [
        Permission.read(Role.users()),
        Permission.create(Role.users()),
        Permission.update(Role.users()),
        Permission.delete(Role.users()),
      ],
      fileSecurity: true,
      maximumFileSize: 10 * 1024 * 1024,
      allowedFileExtensions: ['pdf', 'jpg', 'jpeg', 'png'],
      compression: 'none',
      encryption: true,
      antivirus: true,
      transformations: false,
      enabled: true,
    },
    {
      id: ids.buckets.receipts,
      name: 'Receipts',
      permissions: [
        Permission.read(Role.users()),
        Permission.create(Role.users()),
        Permission.update(Role.users()),
        Permission.delete(Role.users()),
      ],
      fileSecurity: true,
      maximumFileSize: 5 * 1024 * 1024,
      allowedFileExtensions: ['pdf'],
      compression: 'none',
      encryption: true,
      antivirus: true,
      transformations: false,
      enabled: true,
    },
    {
      id: ids.buckets.avatars,
      name: 'Avatars',
      permissions: [
        Permission.read(Role.users()),
        Permission.create(Role.users()),
        Permission.update(Role.users()),
        Permission.delete(Role.users()),
      ],
      fileSecurity: true,
      maximumFileSize: 2 * 1024 * 1024,
      allowedFileExtensions: ['jpg', 'jpeg', 'png', 'webp'],
      compression: 'none',
      encryption: false,
      antivirus: true,
      transformations: true,
      enabled: true,
    },
  ]
}
